<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Past Tornadoes Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>
  <script src="https://js.arcgis.com/4.21/"></script>
  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    /* Query controls panel */
    #queryControls {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(50, 50, 50, 0.85);
      color: white;
      padding: 12px;
      border-radius: 6px;
      z-index: 20;
      font-family: Arial, sans-serif;
    }

    #queryControls select, #queryControls button {
      margin: 5px 0;
      width: 100%;
      padding: 5px;
    }

    /* Map dropdown */
    #mapDropdown {
      position: absolute;
      top: 10px;
      left: 20px;
      z-index: 20;
      padding: 6px;
      border-radius: 6px;
    }

    /* Title and footer */
    #title {
      position: absolute;
      top: 10px;
      right: 20px;
      background: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      z-index: 20;
    }

    #footer {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.8);
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      z-index: 20;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>

  <!-- Title -->
  <div id="title">Past Tornadoes Map (USA)</div>

  <!-- Footer -->
  <div id="footer">Â© ESRI ArcGIS Services / Open Data Sources</div>

  <!-- Map selection dropdown -->
  <select id="mapDropdown" onchange="openMap()">
    <option value="">-- Choose a Map --</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/tile.layer.html">Tile Layer Map</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/on_event.html">On event Map</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/dynamic.layers.html">Dynamic Map</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/query_task.html">Query Task</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/simple_mapping.html">Simple Mapping</option>
    <option value="https://campbelltxstate.github.io/CampbellTxState/basemap_gallery.html">Basemap Gallery Map</option>
  </select>

  <!-- Query controls panel -->
  <div id="queryControls">
    <label for="tornadoStrength">Tornado Strength:</label>
    <select id="tornadoStrength">
      <option value="0">EF0</option>
      <option value="1">EF1</option>
      <option value="2">EF2</option>
      <option value="3">EF3</option>
      <option value="4">EF4</option>
      <option value="5">EF5</option>
    </select>
    <br>
    <label for="yearSelect">Year:</label>
    <select id="yearSelect">
      <option value="1950">1950</option>
      <option value="1960">1960</option>
      <option value="1970">1970</option>
      <option value="1980">1980</option>
      <option value="1990">1990</option>
      <option value="2000">2000</option>
      <option value="2010">2010</option>
      <option value="2012">2012</option>
      <option value="2015">2015</option>
      <option value="2018">2018</option>
    </select>
    <br>
    <button id="runQuery">Run Query</button>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/TileLayer",
      "esri/layers/FeatureLayer"
    ], function(Map, MapView, TileLayer, FeatureLayer) {

      // Base TileLayer
      var baseLayer = new TileLayer({
        url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"
      });

      // Tornadoes FeatureLayer
      var tornadoLayer = new FeatureLayer({
        url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Past-tornados/FeatureServer/0",
        outFields: ["*"],
        popupTemplate: {
          title: "Tornado: {OM}",
          content: "Year: {YR} <br> Strength: EF{MAG} <br> State: {ST}"
        }
      });

      // Create map
      var map = new Map({
        layers: [baseLayer, tornadoLayer]
      });

      // Create view
      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-95, 38], // Center of USA
        zoom: 4
      });

      // Run query button
      document.getElementById("runQuery").addEventListener("click", function() {
        var strength = parseInt(document.getElementById("tornadoStrength").value); // numeric EF
        var year = parseInt(document.getElementById("yearSelect").value);           // numeric year

        // Build definition expression
        var whereClause = "MAG = " + strength + " AND YR = " + year;
        console.log("Applying where clause:", whereClause);

        // Apply filter to layer
        tornadoLayer.definitionExpression = whereClause;

        // Animate view to filtered features
        tornadoLayer.queryExtent().then(function(response) {
          if (response.extent) {
            view.goTo(response.extent.expand(1.2), { duration: 1500 });
          } else {
            alert("No tornadoes found for this selection.");
          }
        }).catch(function(err) {
          console.error("Error querying tornadoes:", err);
        });
      });

      // Map dropdown open function
      window.openMap = function() {
        var dropdown = document.getElementById("mapDropdown");
        var url = dropdown.value;
        if (url) {
          window.open(url, "_blank");
          dropdown.selectedIndex = 0;
        }
      };
    });
  </script>
</body>
</html>
